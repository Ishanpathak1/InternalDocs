---
import { getEntry, getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const slug = Astro.params.slug;
const id = typeof slug === 'string' ? slug : slug ? slug.join('/') : '';
if (!id) {
  return Astro.redirect('/docs');
}

const entry = await getEntry('docs', id);
if (!entry) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const allDocs = await getCollection('docs');
const moreDocs = allDocs
  .filter((e) => e.id !== entry.id)
  .sort((a, b) => (b.data.pubDate?.valueOf() ?? 0) - (a.data.pubDate?.valueOf() ?? 0));

const { Content } = await render(entry);
const writtenDate = entry.data.pubDate
  ? new Date(entry.data.pubDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;
---
<BaseLayout title={entry.data.title}>
  <style is:global>
    /* One solid background on the block only – no per-line “highlight” */
    .doc-prose pre *,
    .doc-prose pre code,
    .doc-prose pre span,
    .doc-prose pre [data-highlighted-line],
    .doc-prose pre [data-highlighted-chars] { background: transparent !important; }
    /* Dark mode: single dark background; Shiki syntax colors stay */
    html.dark .doc-prose pre {
      background: #0f172a !important;
      color: #e2e8f0;
      border-color: #334155;
    }
    /* Light mode: single light background, readable font/color */
    html:not(.dark) .doc-prose pre {
      background: #f8fafc !important;
      color: #334155;
      border-color: #e2e8f0;
    }
    html:not(.dark) .doc-prose pre,
    html:not(.dark) .doc-prose pre code,
    html:not(.dark) .doc-prose pre span {
      color: #334155 !important;
      font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, monospace;
    }
    /* Tables: clean layout and readable font */
    .doc-prose table {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      font-size: 0.9375rem;
      width: 100%;
      border-collapse: collapse;
    }
    .doc-prose table th,
    .doc-prose table td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: top;
      text-align: left;
    }
    html.dark .doc-prose table th,
    html.dark .doc-prose table td {
      border-bottom-color: #475569;
    }
    .doc-prose table th {
      font-weight: 600;
      color: #475569;
    }
    html.dark .doc-prose table th {
      color: #94a3b8;
    }
    .doc-prose table td {
      color: #334155;
    }
    html.dark .doc-prose table td {
      color: #cbd5e1;
    }
    /* Inline code inside tables: subtle, same font as table text */
    .doc-prose table code {
      font-family: 'Source Sans 3', system-ui, sans-serif !important;
      font-size: inherit !important;
      font-weight: 500;
      background: #f1f5f9 !important;
      color: #1e293b !important;
      padding: 0.15em 0.4em !important;
      border-radius: 4px;
      border: none;
    }
    html.dark .doc-prose table code {
      background: #334155 !important;
      color: #e2e8f0 !important;
    }
  </style>
  <article
    class="mx-auto max-w-[900px] rounded-2xl bg-white px-6 py-10 shadow-sm transition-colors dark:bg-slate-800 dark:shadow-none sm:px-12 sm:py-14"
    style="font-family: 'Lora', Georgia, serif;"
  >
    <header class="mb-10">
      <h1
        class="text-[2rem] font-bold leading-tight tracking-tight text-[#1a1a1a] dark:text-slate-100 sm:text-[2.75rem]"
        style="font-family: 'Source Sans 3', system-ui, sans-serif;"
      >
        {entry.data.title}
      </h1>
      {entry.data.description && (
        <p class="mt-5 text-[1.25rem] leading-[1.6] text-[#4a4a4a] dark:text-slate-300">
          {entry.data.description}
        </p>
      )}
      <div
        class="mt-6 flex flex-wrap items-center gap-x-3 gap-y-1 border-b border-[#e8e6e3] pb-6 text-sm text-[#6b6b6b] dark:border-slate-600 dark:text-slate-400"
        style="font-family: 'Source Sans 3', system-ui, sans-serif;"
      >
        {entry.data.author && (
          <span class="font-medium text-[#1a1a1a] dark:text-slate-200">{entry.data.author}</span>
        )}
        {entry.data.author && writtenDate && (
          <span class="text-[#c4c4c4] dark:text-slate-500" aria-hidden="true">·</span>
        )}
        {writtenDate && (
          <time datetime={entry.data.pubDate?.toISOString()}>{writtenDate}</time>
        )}
        {entry.data.codeLocation && (
          <>
            <span class="text-[#c4c4c4] dark:text-slate-500" aria-hidden="true">·</span>
            <a
              href={entry.data.codeLocation.startsWith('http') ? entry.data.codeLocation : '#'}
              target={entry.data.codeLocation.startsWith('http') ? '_blank' : undefined}
              rel={entry.data.codeLocation.startsWith('http') ? 'noopener noreferrer' : undefined}
              class="rounded-md bg-[#f0efec] px-2 py-0.5 text-xs text-[#555] hover:bg-[#e8e6e3] hover:text-[#1a1a1a] dark:bg-slate-600 dark:text-slate-300 dark:hover:bg-slate-500 dark:hover:text-slate-100"
            >
              {entry.data.codeLocation}
            </a>
          </>
        )}
      </div>
    </header>
    <div
      class="doc-prose prose prose-lg max-w-none prose-headings:font-sans prose-headings:font-semibold prose-headings:tracking-tight prose-headings:text-[#1a1a1a] dark:prose-headings:text-slate-100 prose-p:text-[1.125rem] prose-p:leading-[1.8] prose-p:text-[#292929] dark:prose-p:text-slate-200 prose-a:text-[#1a1a1a] dark:prose-a:text-sky-300 prose-a:underline prose-a:decoration-[#1a1a1a]/30 dark:prose-a:decoration-sky-400/50 prose-a:underline-offset-2 hover:prose-a:decoration-[#1a1a1a] dark:hover:prose-a:decoration-sky-400 prose-strong:text-[#1a1a1a] dark:prose-strong:text-slate-100 prose-code:rounded prose-code:bg-[#f0efec] dark:prose-code:bg-slate-600 prose-code:px-1.5 prose-code:py-0.5 prose-code:text-[0.9em] prose-code:before:content-none prose-code:after:content-none prose-code:font-mono prose-code:text-[#1a1a1a] dark:prose-code:text-slate-200 prose-pre:!mt-6 prose-pre:!mb-6 prose-pre:overflow-x-auto prose-pre:rounded-xl prose-pre:border prose-pre:border-slate-200/80 prose-pre:bg-slate-100 prose-pre:px-4 prose-pre:py-4 prose-pre:font-mono prose-pre:text-sm prose-pre:leading-relaxed prose-pre:text-slate-800 dark:prose-pre:border-slate-600 dark:prose-pre:bg-slate-950 dark:prose-pre:text-slate-100 prose-pre_[code]:bg-transparent prose-pre_[code]:p-0 prose-pre_[code]:text-inherit prose-blockquote:border-l-4 prose-blockquote:border-[#1a1a1a]/20 dark:prose-blockquote:border-slate-500 prose-blockquote:bg-[#fafaf9] dark:prose-blockquote:bg-slate-800/50 prose-blockquote:py-1 prose-blockquote:pl-5 prose-blockquote:italic prose-blockquote:text-[#4a4a4a] dark:prose-blockquote:text-slate-300 prose-li:text-[#292929] dark:prose-li:text-slate-200"
      style="font-family: 'Lora', Georgia, serif;"
    >
      <Content />
    </div>
    <footer class="mt-14 border-t border-[#e8e6e3] pt-6 dark:border-slate-600">
      <a
        href="/docs"
        class="inline-flex items-center gap-2 text-sm text-[#6b6b6b] hover:text-[#1a1a1a] dark:text-slate-400 dark:hover:text-slate-200"
        style="font-family: 'Source Sans 3', system-ui, sans-serif;"
      >
        <span aria-hidden="true">←</span> Back to docs
      </a>
      {moreDocs.length > 0 && (
        <div
          class="mt-8 rounded-xl border border-[#e8e6e3] bg-[#fafaf9] px-5 py-4 dark:border-slate-600 dark:bg-slate-800/50"
          style="font-family: 'Source Sans 3', system-ui, sans-serif;"
        >
          <h2 class="text-sm font-semibold uppercase tracking-wide text-[#6b6b6b] dark:text-slate-400">
            More docs
          </h2>
          <ul class="mt-3 flex flex-wrap gap-x-4 gap-y-1">
            {moreDocs.map((doc) => (
              <li>
                <a
                  href={`/docs/${doc.id}`}
                  class="text-[#1a1a1a] underline decoration-[#1a1a1a]/30 underline-offset-2 hover:decoration-[#1a1a1a] dark:text-slate-200 dark:decoration-slate-400/50 dark:hover:decoration-slate-300"
                >
                  {doc.data.title}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}
    </footer>
  </article>
</BaseLayout>
