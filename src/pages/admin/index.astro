---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { listUsers } from '../../lib/auth-data';

const user = Astro.locals.user ?? null;
if (!user || user.role !== 'admin') {
  return Astro.redirect('/docs');
}

const users = listUsers();
---
<BaseLayout title="Admin" user={user}>
  <div class="mx-auto max-w-5xl space-y-8">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Admin</h1>
    <p class="text-slate-600 dark:text-slate-400">Create one-time access codes and view members. Your email has admin access.</p>

    <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-600 dark:bg-slate-800">
      <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Generate access code</h2>
      <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Share this code once; it can only be used to create one account.</p>
      <form id="generate-form" class="mt-4 flex flex-wrap items-end gap-4">
        <div>
          <label for="role" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Role for new user</label>
          <select
            id="role"
            name="role"
            class="mt-1 rounded border border-slate-300 px-3 py-2 text-slate-900 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500 dark:border-slate-500 dark:bg-slate-700 dark:text-slate-100 dark:focus:ring-slate-400"
          >
            <option value="member">member</option>
            <option value="developer">developer</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <button
          type="submit"
          class="rounded bg-slate-800 px-4 py-2 font-medium text-white hover:bg-slate-700 dark:bg-slate-600 dark:hover:bg-slate-500"
        >
          Generate code
        </button>
      </form>
      <div id="code-result" class="mt-4 hidden rounded border border-slate-200 bg-slate-50 p-4 dark:border-slate-600 dark:bg-slate-700">
        <p class="text-sm font-medium text-slate-700 dark:text-slate-300">One-time code (copy and share):</p>
        <code id="code-value" class="mt-1 block break-all font-mono text-slate-900 dark:text-slate-100"></code>
      </div>
    </section>

    <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-600 dark:bg-slate-800">
      <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Members</h2>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 text-left text-sm dark:divide-slate-600">
          <thead>
            <tr>
              <th class="py-2 pr-4 font-medium text-slate-700 dark:text-slate-300">Email</th>
              <th class="py-2 pr-4 font-medium text-slate-700 dark:text-slate-300">Role</th>
              <th class="py-2 pr-4 font-medium text-slate-700 dark:text-slate-300">Start date</th>
              <th class="py-2 font-medium text-slate-700 dark:text-slate-300">GitHub</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 dark:divide-slate-600">
            {users.map((u) => (
              <tr>
                <td class="py-2 pr-4 text-slate-900 dark:text-slate-200">{u.email}</td>
                <td class="py-2 pr-4 text-slate-700 dark:text-slate-300">{u.role}</td>
                <td class="py-2 pr-4 text-slate-700 dark:text-slate-300">{u.startDate}</td>
                <td class="py-2 text-slate-600 dark:text-slate-400">
                  {u.githubUrl ? (
                    <a href={u.githubUrl} target="_blank" rel="noopener noreferrer" class="text-slate-600 hover:underline dark:text-sky-400 dark:hover:text-sky-300">
                      {u.githubUrl.replace(/^https?:\/\//, '').slice(0, 30)}…
                    </a>
                  ) : (
                    '—'
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        {users.length === 0 && (
          <p class="py-4 text-slate-500 dark:text-slate-400">No members yet. Generate a code and share it to add someone.</p>
        )}
      </div>
    </section>
  </div>

  <script>
    const form = document.getElementById('generate-form') as HTMLFormElement;
    const codeResult = document.getElementById('code-result') as HTMLDivElement;
    const codeValue = document.getElementById('code-value') as HTMLElement;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const res = await fetch('/api/admin/codes', {
        method: 'POST',
        body: formData,
      });
      if (!res.ok) {
        alert('Failed to generate code');
        return;
      }
      const data = await res.json();
      codeValue.textContent = data.code;
      codeResult.classList.remove('hidden');
    });
  </script>
</BaseLayout>
